version: 2
jobs:
  build:
    docker:
      # CircleCI Go images available at: https://hub.docker.com/r/circleci/golang/
      - image: circleci/golang:1.11

    working_directory: /go/src/github.com/yoshihara/blog

    steps:
      - checkout
      - run:
          name: install awscli
          command: sudo apt-get update && sudo apt-get install -y awscli

      - restore_cache:
          keys:
            - hugo-0.51

      - run:
          name: install hugo
          command: |
            wget https://github.com/gohugoio/hugo/releases/download/v0.51/hugo_0.51_Linux-64bit.tar.gz
            tar xvf hugo_0.51_Linux-64bit.tar.gz

      - run:
          name: pull template
          command: |
            git submodule update -i

      - run:
          name: tweak frontmatter for hugo
          command: |
            ./bin/format_esa_md_for_hugo.sh

      - run:
          name: generate
          command: |
            ./hugo

      # awscliに必要な認証はCircleCIのBUILD SETTINGS > Environment Variables で設定している
      - run:
          name: upload S3
          command: |
            aws s3 sync public s3://blog.bomberowl.org/ --delete

      - save_cache:
          key: hugo-0.51
          paths:
            - "./hugo"

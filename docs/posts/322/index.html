<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    
    <title>slackで日程調整するときの準備をシェルスクリプトで自動化した | hyoshi(hara) log</title>
    
    <meta property='og:title' content='slackで日程調整するときの準備をシェルスクリプトで自動化した - hyoshi(hara) log'>
<meta property='og:description' content='slackで↓のような感じでemojiを使って予定を調整することがあります。 が、色々面倒なのでシェルスクリプトで自動化しました。 reacti'>
<meta property='og:url' content='https://blog.bomberowl.org/posts/322/'>
<meta property='og:site_name' content='hyoshi(hara) log'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:published_time' content='2018-06-25T23:09:28&#43;09:00'/><meta property='article:modified_time' content='2018-06-25T23:09:28&#43;09:00'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@hyoshihara04'><meta name='twitter:creator' content='@hyoshihara04'>
    
    <link rel="stylesheet" href="/css/style.css"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
  </head>
  <body>

<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://blog.bomberowl.org">
          <h1 class="title is-4">hyoshi(hara) log</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/yoshihara'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/hyoshihara04'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
    </div>
    <h2 class="subtitle is-6">June 25, 2018</h2>
    <h1 class="title">slackで日程調整するときの準備をシェルスクリプトで自動化した</h1>
    
    <div class="content">
      

<p>slackで↓のような感じでemojiを使って予定を調整することがあります。</p>

<p><img src="https://img.esa.io/uploads/production/attachments/1303/2018/05/24/144/8b9fba67-7140-46ba-8498-a9408b483ddf.png" alt="image.png (36.1 kB)" /></p>

<p>が、色々面倒なのでシェルスクリプトで自動化しました。</p>

<ul>
<li>reactionをつけられるようにするために1日ずつ発言しないといけなくてめんどい</li>
<li>reactionをポチポチ選んだり <code>+ :ok_woman:</code> するのめんどい（しかも発言ごとに繰り返し）</li>
</ul>

<p>日付を発言するときに曜日は日本語にしたいのですが、ターミナルで半角全角どっちも打つの面倒だった（英語表記にすればいいけど日本語のほうが個人的にわかりやすいので好き）のと、どうせ日付しか入れないし自動化しようと思って、ツェラーの公式を使って計算するようにしました。
なお、動作はMacで確認しています。</p>

<h2 id="使い方">使い方</h2>

<p><code>jq</code> をインストールしておきます。（Homebrew だと <code>brew install jq</code> ）</p>

<p>書き込みたいslackのTokenが必要なので <a href="https://api.slack.com/custom-integrations/legacy-tokens">https://api.slack.com/custom-integrations/legacy-tokens</a> に行って取得します。シェルスクリプトのためにOAuthするの大変だったのでlegacy token使ってますが、気になる方は適宜修正してください。最終的にAPIを叩くためのTokenが手に入っていればコードのそれ以外の部分は大丈夫のはず。</p>

<p>その後、↓のコードをコピーして適当に保存します。（ここでは <code>chousei-kun.sh</code> ）そしたらさっき作ったTokenでコード内の <code>YOUR_TOKEN</code> を置き換えてください。</p>

<p>（ちなみに <code>set -eu</code> の前にtokenを設定してるのは、もし <code>set -eu</code> のあとでtokenを設定してるときにデバッグで <code>set -eux</code> にして標準出力にTokenが出るのが嫌だったからです）</p>

<p>あと <code>username</code> , <code>teamname</code> , <code>reactions</code> を適宜修正します。 <code>teamname</code> は <code>#</code> が必要だけど <code>curl</code> で送信する関係でエンコードして <code>%23</code> にしておく必要があります。シェルでエンコードまでしようかと思ったけど、そこそこ面倒そうな割に、そんなにコード中で使わないのでやめました。</p>

<p>これで設定は終わりなので、後は↓のような感じで実行すると、指定した日付から自動で曜日を取得して一つずつ <code>username</code> として <code>teamname</code> のチャンネルに発言し、 <code>reactions</code> にあるemojiでreactionします。</p>

<pre><code class="language-console">./chousei-kun.sh 20180423 20180524 20180630
</code></pre>

<h2 id="コード">コード</h2>

<pre><code class="language-sh">#!/bin/bash

# Usage:
#  chousei-kun.sh 20180423 20180524 20180630

# tokenは https://api.slack.com/custom-integrations/legacy-tokens で取得
token=YOUR_TOKEN

set -eu

username=&quot;hyoshihara&quot;
teamname=&quot;%23general&quot; # URLエンコードしておくこと（ %23=# ）
reactions=(&quot;ok_woman&quot; &quot;no_good&quot;)

# ツェラーの公式で曜日を算出する
# https://ja.wikipedia.org/wiki/%E3%83%84%E3%82%A7%E3%83%A9%E3%83%BC%E3%81%AE%E5%85%AC%E5%BC%8F
calc-day() {
    year=$1
    month=$2
    day=$3

    if [ $month -le 2 ]; then
        month=`expr $month + 12`
        year=`expr $year - 1`
    fi

    c=`expr $year / 100`
    y=`expr $year % 100`

    item1=`expr \( $month + 1 \) \* 26 / 10`
    item2=`expr $y / 4`
    gregorian=`expr -2 \* $c + $c / 4`

    dayNum=`expr \( $day + $item1 + $y + $item2 + $gregorian \) % 7`
    dates=(&quot;土&quot; &quot;日&quot; &quot;月&quot; &quot;火&quot; &quot;水&quot; &quot;木&quot; &quot;金&quot;)

    echo ${dates[${dayNum}]}
}

for candidate in $@
do
    # candidateは yyyymmdd を想定
    y=${candidate:0:4}
    m=${candidate:4:2}
    d=${candidate:6:2}
    target=&quot;$y-$m-$d%20(`calc-day $y $m $d`)&quot; # %20 = 半角スペース
    echo $target
    res=`curl \
    --data token=${token} \
    --data channel=${teamname} \
    --data text=${target} \
    --data as_user=${username} \
    -s \
    &quot;https://slack.com/api/chat.postMessage&quot;`

    if [ `echo $res | jq .&quot;ok&quot;` != &quot;true&quot; ]; then
        echo &quot;postMessage: ${target} is failed&quot;
        echo error: `echo $res | jq .&quot;error&quot;`
        exit -1
    fi

    channel=`echo $res | jq -r .&quot;channel&quot;`
    ts=`echo $res | jq -r .&quot;ts&quot;`

    for reaction in ${reactions[@]}
    do
        # reaction追加のタイミング早すぎるとemojiの並び順が安定しないので待っている
        sleep 1

        res=`curl \
        --data token=${token} \
        --data channel=${channel} \
        --data name=${reaction} \
        --data timestamp=${ts} \
        -s \
        &quot;https://slack.com/api/reactions.add&quot;`

        if [ `echo $res | jq .&quot;ok&quot;` != &quot;true&quot; ]; then
            echo &quot;reactions.add: ${reaction} for ${target} is failed&quot;
            echo error: `echo $res | jq .&quot;error&quot;`
            exit -1
        fi
    done
done

echo &quot;Done.&quot;
</code></pre>

<h2 id="ツェラーの公式の実装について">ツェラーの公式の実装について</h2>

<p>公式自体の詳細はググっていただくとして、Wikipedia見て愚直に実装しました。変数名とかはWikipedia準拠です。なんか間違ってた時に自分で直しやすい実装をしようと思って書いたので、もし別のやり方をしたい方は適宜修正してください。</p>

      
    </div>
    
  </div>
</section>


<section class="section">
  <div class="container has-text-right">
    
    <div class="addthis_inline_share_toolbox"></div>
  </div>
</section>

<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://github.com/yoshihara">yoshihara</a> 2017-2018</p>
    
    <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>




<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5a4ac93ed1b0ded1"></script>

</body>
</html>

